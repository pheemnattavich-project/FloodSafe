<script>
        // 1. LIFF ID ของคุณ
        const YOUR_LIFF_ID = "2008850608-gCaJNTgd"; 
        const GAS_URL = "https://script.google.com/macros/s/AKfycbwGiW13vEERZ8MFKsmf3pXPumkRWvKBxTqCDnkdNpaNS3FL8pvPPnNmscqeK7otjDUY5g/exec";

        // เริ่มต้นใช้งาน LIFF
        async function main() {
            try {
                await liff.init({ liffId: YOUR_LIFF_ID });
                
                // ถ้าเปิดใน External Browser ให้ปุ่มส่งทำงานได้ปกติ แต่จะไม่ Login
                if (liff.isInClient()) {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    }
                }
            } catch (err) {
                console.error("LIFF Init failed", err);
                // ไม่ต้อง Alert error ตอนเปิด เพื่อไม่ให้รบกวนผู้ใช้
            }
        }
        main();

        async function sendData() {
            // ล็อคปุ่มทันทีเพื่อกันกดซ้ำ
            const btn = document.getElementById('btnSend');
            btn.disabled = true;
            btn.innerText = "กำลังส่ง...";

            const name = document.getElementById('name').value;
            const location = document.getElementById('location').value;
            const details = document.getElementById('details').value;
            
            // ดึง UserID อย่างปลอดภัย
            let userId = "Guest";
            try {
                // เช็คก่อนว่า LIFF พร้อมใช้งานไหม
                if (liff.isInClient() && liff.getContext()) {
                    userId = liff.getContext().userId || "Guest";
                }
            } catch (e) { console.log(e); }

            try {
                await fetch(GAS_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        location: location,
                        details: details,
                        userId: userId
                    })
                });

                // --- ส่วนที่แก้ไขเพื่อแก้ปัญหาปิดหน้าจอไม่ได้ ---
                
                // แสดงข้อความเสร็จสิ้น
                alert('ส่งข้อมูลเรียบร้อยแล้ว');

                // เช็คว่าเปิดอยู่ในแอป LINE หรือไม่
                if (liff.isInClient()) {
                    // ปิดหน้าต่างทันที
                    liff.closeWindow();
                } else {
                    // กรณีเปิด browser ข้างนอก ให้รีเฟรชหน้าจอแทน
                    window.location.reload(); 
                }
                // ------------------------------------------

            } catch (err) {
                alert('เกิดข้อผิดพลาด: ' + err);
                // คืนค่าปุ่มให้กดใหม่ได้
                btn.disabled = false;
                btn.innerText = "ส่งข้อมูล";
            }
        }
    </script>
